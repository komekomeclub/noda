<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Recorder</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f4f4f4; }
        h1 { font-size: 1.2rem; text-align: center; color: #333; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        button { padding: 15px 30px; font-size: 1rem; border: none; border-radius: 50px; cursor: pointer; }
        #btnRecord { background: #ff4d4d; color: white; }
        #btnRecord.recording { animation: pulse 1.5s infinite; background: #cc0000; }
        #btnStop { background: #333; color: white; display: none; }
        .status { text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 15px; min-height: 1.2em; }
        
        .search-box { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .list { list-style: none; padding: 0; }
        .item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .item-date { font-size: 0.8rem; color: #999; margin-bottom: 5px; }
        .item-text { font-size: 0.95rem; margin-bottom: 10px; line-height: 1.4; }
        audio { width: 100%; margin-top: 10px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>Whisper ボイスレコーダー</h1>
    
    <div class="status" id="statusMessage">モデル準備中... (初回は時間がかかります)</div>

    <div class="controls">
        <button id="btnRecord" disabled>録音開始</button>
        <button id="btnStop">停止 & 文字起こし</button>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="キーワードで検索...">

    <ul class="list" id="recordingsList"></ul>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';

        // スマホ向け設定: WebAssemblyのパス指定とモデルの軽量化
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        // DB初期化
        const db = new Dexie("VoiceRecorderDB");
        db.version(1).stores({
            recordings: '++id, timestamp, text' // textで検索できるようにインデックス化
        });

        // DOM要素
        const btnRecord = document.getElementById('btnRecord');
        const btnStop = document.getElementById('btnStop');
        const statusMsg = document.getElementById('statusMessage');
        const listEl = document.getElementById('recordingsList');
        const searchInput = document.getElementById('searchInput');

        let mediaRecorder;
        let audioChunks = [];
        let transcriber = null;

        // 1. Whisperモデルのロード (初期化)
        async function initModel() {
            try {
                // スマホ向けに軽量な 'whisper-tiny' を指定
                transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny');
                statusMsg.textContent = "準備完了";
                btnRecord.disabled = false;
            } catch (e) {
                console.error(e);
                statusMsg.textContent = "モデル読み込みエラー";
            }
        }

        // 2. 録音機能
        btnRecord.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                await processRecording(audioBlob);
            };

            mediaRecorder.start();
            btnRecord.style.display = 'none';
            btnStop.style.display = 'inline-block';
            statusMsg.textContent = "録音中...";
        };

        btnStop.onclick = () => {
            mediaRecorder.stop();
            btnRecord.style.display = 'inline-block';
            btnStop.style.display = 'none';
            btnRecord.classList.remove('recording');
        };

        // 3. 音声処理と文字起こし
        async function processRecording(blob) {
            statusMsg.textContent = "文字起こし中... (少々お待ちください)";
            
            // Audio BlobをURLに変換してWhisperに渡す準備
            const audioUrl = URL.createObjectURL(blob);

            try {
                // 文字起こし実行
                const output = await transcriber(audioUrl, {
                    language: 'japanese',
                    task: 'transcribe'
                });
                
                const text = output.text;

                // DBに保存
                await db.recordings.add({
                    timestamp: new Date(),
                    audio: blob,
                    text: text
                });

                statusMsg.textContent = "保存完了";
                loadRecordings(); // リスト更新

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "エラーが発生しました";
            }
        }

        // 4. リスト表示と検索機能
        async function loadRecordings(query = "") {
            listEl.innerHTML = '';
            
            let collection = db.recordings.orderBy('timestamp').reverse();
            
            // 検索フィルタ
            if (query) {
                const results = await db.recordings
                    .filter(rec => rec.text.includes(query))
                    .reverse()
                    .toArray();
                renderList(results);
            } else {
                const results = await collection.toArray();
                renderList(results);
            }
        }

        function renderList(items) {
            if (items.length === 0) {
                listEl.innerHTML = '<li style="text-align:center; color:#999;">データがありません</li>';
                return;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'item';
                
                const dateStr = item.timestamp.toLocaleString();
                const audioUrl = URL.createObjectURL(item.audio);

                li.innerHTML = `
                    <div class="item-date">${dateStr}</div>
                    <div class="item-text">${item.text}</div>
                    <audio controls src="${audioUrl}"></audio>
                `;
                listEl.appendChild(li);
            });
        }

        // 検索イベント
        searchInput.addEventListener('input', (e) => {
            loadRecordings(e.target.value);
        });

        // 初期実行
        initModel();
        loadRecordings();

    </script>
</body>
</html>
